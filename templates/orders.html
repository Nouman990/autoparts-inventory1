{% extends "base.html" %}
{% block title %}Orders{% endblock %}
{% block page_title %}Orders{% endblock %}

{% block content %}
<div style="display:flex;gap:12px;margin-bottom:24px;flex-wrap:wrap;align-items:center;">
  <input id="search" type="text" class="input" placeholder="Search by product name..." style="flex:1;min-width:200px;" oninput="load(1)">
  <select id="acc-filter" class="input" style="width:160px;" onchange="load(1)">
    <option value="">All Accounts</option>
    <option value="PMC">PMC</option>
    <option value="Powergen">Powergen</option>
  </select>
</div>

<div class="card">
  <div id="orders-table"><div style="text-align:center;padding:40px;color:#475569;"><i class="fas fa-spinner fa-spin"></i> Loading...</div></div>
</div>
<div id="pagination" style="display:flex;gap:8px;margin-top:16px;justify-content:center;flex-wrap:wrap;"></div>
{% endblock %}

{% block extra_js %}
<script>
async function load(page=1){
  const data=await api(`/api/orders/list?page=${page}&per_page=20`);
  const c=document.getElementById('orders-table');
  if(!data.orders||!data.orders.length){c.innerHTML='<p style="color:#475569;text-align:center;padding:40px;">No orders yet</p>';return;}
  c.innerHTML=`<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:13px;">
    <thead><tr style="border-bottom:1px solid #334155;color:#475569;text-align:left;">
      <th style="padding:10px;">Product</th><th style="padding:10px;">Qty</th>
      <th style="padding:10px;">Price</th><th style="padding:10px;">Account</th>
      <th style="padding:10px;">eBay Order ID</th><th style="padding:10px;">Buyer</th>
      <th style="padding:10px;">Date</th><th style="padding:10px;"></th>
    </tr></thead><tbody>
    ${data.orders.map(o=>`
      <tr style="border-bottom:1px solid #1e293b;" onmouseover="this.style.background='#0f172a'" onmouseout="this.style.background='transparent'">
        <td style="padding:10px;">
          <div style="display:flex;align-items:center;gap:8px;">
            ${o.product_image?`<img src="${o.product_image}" style="width:36px;height:36px;border-radius:6px;object-fit:cover;">`:
            `<div style="width:36px;height:36px;border-radius:6px;background:#334155;"></div>`}
            <a href="/products/${o.product_id}" style="color:#818cf8;font-weight:600;text-decoration:none;">${o.product_title||'—'}</a>
          </div>
        </td>
        <td style="padding:10px;font-weight:700;color:#fb923c;">${o.quantity_sold}</td>
        <td style="padding:10px;color:#4ade80;">$${o.sale_price}</td>
        <td style="padding:10px;"><span class="${o.account==='PMC'?'badge-pmc':'badge-powergen'}">${o.account||'—'}</span></td>
        <td style="padding:10px;color:#64748b;font-size:12px;">${o.ebay_order_id||'—'}</td>
        <td style="padding:10px;color:#94a3b8;">${o.buyer_name||'—'}</td>
        <td style="padding:10px;color:#64748b;">${new Date(o.created_at).toLocaleDateString()}</td>
        <td style="padding:10px;"><button onclick="del('${o._id}')" style="background:none;border:none;cursor:pointer;color:#475569;"><i class="fas fa-trash"></i></button></td>
      </tr>
    `).join('')}
    </tbody></table></div>`;
}

async function del(oid){
  if(!confirm('Delete order? Qty will be restored to product.')) return;
  const d=await api('/api/orders/'+oid,{method:'DELETE'});
  if(d.success){toast('Deleted & qty restored','success');load();}
  else toast(d.error||'Error','error');
}

load();
</script>
{% endblock %}
