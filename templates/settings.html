{% extends "base.html" %}
{% block title %}Settings{% endblock %}
{% block page_title %}Settings{% endblock %}

{% block content %}
<div style="max-width:700px;">

  <!-- Change Password -->
  <div class="card" style="margin-bottom:20px;">
    <h3 style="font-weight:700;color:#e2e8f0;margin-bottom:16px;"><i class="fas fa-lock" style="color:#818cf8;margin-right:8px;"></i>Change Password</h3>
    <div style="display:grid;gap:12px;max-width:400px;">
      <div><label class="label">Current Password</label><input id="old-pw" type="password" class="input"></div>
      <div><label class="label">New Password</label><input id="new-pw" type="password" class="input"></div>
      <button onclick="changePw()" class="btn-primary" style="width:fit-content;"><i class="fas fa-save"></i> Update Password</button>
    </div>
  </div>

  <!-- Team Users -->
  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <h3 style="font-weight:700;color:#e2e8f0;"><i class="fas fa-users" style="color:#818cf8;margin-right:8px;"></i>Team Members</h3>
      <button onclick="document.getElementById('add-user-form').style.display='block'" class="btn-primary" style="font-size:13px;padding:8px 14px;"><i class="fas fa-plus"></i> Add User</button>
    </div>

    <div id="add-user-form" style="display:none;background:#0f172a;border:1px solid #334155;border-radius:12px;padding:16px;margin-bottom:16px;">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
        <div><label class="label">Name</label><input id="u-name" type="text" class="input" placeholder="John Doe"></div>
        <div><label class="label">Email</label><input id="u-email" type="email" class="input" placeholder="john@..."></div>
        <div><label class="label">Password</label><input id="u-pass" type="password" class="input" placeholder="pass123"></div>
        <div><label class="label">Role</label>
          <select id="u-role" class="input"><option value="user">User</option><option value="admin">Admin</option></select>
        </div>
      </div>
      <div style="display:flex;gap:8px;">
        <button onclick="addUser()" class="btn-primary"><i class="fas fa-check"></i> Create</button>
        <button onclick="document.getElementById('add-user-form').style.display='none'" class="btn-secondary"><i class="fas fa-times"></i> Cancel</button>
      </div>
    </div>

    <div id="users-list"></div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function changePw(){
  const d=await api('/api/auth/change-password',{method:'POST',body:JSON.stringify({old_password:document.getElementById('old-pw').value,new_password:document.getElementById('new-pw').value})});
  if(d.success){toast('Password updated!','success');document.getElementById('old-pw').value='';document.getElementById('new-pw').value='';}
  else toast(d.error||'Error','error');
}

async function loadUsers(){
  const d=await api('/api/auth/users');
  const c=document.getElementById('users-list');
  c.innerHTML=d.users.map(u=>`
    <div style="display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid #1e293b;">
      <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#7c3aed,#6d28d9);display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;flex-shrink:0;">${(u.name||u.email)[0].toUpperCase()}</div>
      <div style="flex:1;">
        <p style="font-weight:600;color:#e2e8f0;font-size:14px;">${u.name||'â€”'}</p>
        <p style="color:#64748b;font-size:12px;">${u.email}</p>
      </div>
      <span style="background:${u.role==='admin'?'rgba(124,58,237,.2)':'rgba(51,65,85,.5)'};color:${u.role==='admin'?'#a78bfa':'#94a3b8'};padding:3px 10px;border-radius:20px;font-size:12px;font-weight:600;">${u.role}</span>
    </div>
  `).join('');
}

async function addUser(){
  const d=await api('/api/auth/users',{method:'POST',body:JSON.stringify({name:document.getElementById('u-name').value,email:document.getElementById('u-email').value,password:document.getElementById('u-pass').value,role:document.getElementById('u-role').value})});
  if(d.success){toast('User created!','success');document.getElementById('add-user-form').style.display='none';loadUsers();}
  else toast(d.error||'Error','error');
}

loadUsers();
</script>
{% endblock %}
